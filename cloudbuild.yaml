steps:

# Create the image builder for later steps.
- name: gcr.io/cloud-builders/docker
  args: [
    'build', '-t', 'k8s_support_builder', '-f',
    '/workspace/manage-cluster/Dockerfile.k8s_support_builder', '/workspace/'
  ]

# Create the configs
- name: k8s_support_builder
  dir: '/workspace/manage-cluster'
  entrypoint: '/workspace/manage-cluster/create_k8s_configs.sh'
  args:
  - $PROJECT_ID

# Fetch the KUBECONFIG file from GCS.
- name: gcr.io/cloud-builders/gsutil
  dir: '/workspace/manage-cluster'
  args: ['cp', 'gs://k8s-support-$PROJECT_ID/admin.conf', '/workspace/admin.conf' ]

# Push the configs.
- name: 'gcr.io/cloud-builders/kubectl'
  dir: '/workspace/manage-cluster'
  entrypoint: '/workspace/manage-cluster/apply_k8s_configs.sh'
  args:
  - $PROJECT_ID
  - /workspace/admin.conf
