apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: ndt
  namespace: default
spec:
  selector:
    matchLabels:
      run: ndt
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      # TODO: Find a way of ensuring that "5%" never takes an entire site down at once.
      maxUnavailable: 5%
  template:
    metadata:
      labels:
        run: ndt
      annotations:
        prometheus.io/scrape: 'true'
        k8s.v1.cni.cncf.io/networks: '[
          { "name": "flannel-conf" },
          { "name": "index2ip-index-2-conf" } ]'
    spec:
      # The default grace period after k8s sends SIGTERM is 30s. We extend the
      # grace period to give time for the following shutdown sequence. After the
      # grace period, kubernetes sends SIGKILL.
      #
      # NDT pod shutdown sequence:
      #
      #  * k8s sends SIGTERM to NDT server
      #  * NDT server enables lame duck status
      #  * monitoring reads lame duck status (60s max)
      #  * mlab-ns updates server status (60s max)
      #  * all currently running tests complete. (30s max)
      #
      # Feel free to change this to a smaller value for speedy sandbox
      # deployments to enable faster compile-run-debug loops, but 60+60+30=150
      # is what it needs to be for staging and prod.
      terminationGracePeriodSeconds: 150

      nodeSelector:
        mlab/type: 'platform'
      containers:
      - name: ndt-server
        image: measurementlab/ndt-server:v0.6.2
        args:
        - -key=/certs/key.pem
        - -cert=/certs/cert.pem
        - -uuid-prefix-file=/var/local/uuid/prefix
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: ndt-tls
          mountPath: /certs
          readOnly: true
        - name: uuid-prefix
          mountPath: /var/local/uuid
          readOnly: true

      - name: fast-sidestream
        image: measurementlab/tcp-info:v0.0.4
        args:
        - -prom=:9797
        - -uuid-prefix-file=/var/local/uuid/prefix
        ports:
        - containerPort: 9797
        volumeMounts:
        - name: fast-sidestream-data
          mountPath: /home
        - name: uuid-prefix
          mountPath: /var/local/uuid
          readOnly: true

      - name: pusher
        image: measurementlab/pusher:v1.5
        env:
        - name: DIRECTORY
          value: /var/spool/fast-sidestream
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /etc/credentials/pusher.json
        - name: BUCKET
          valueFrom:
            configMapKeyRef:
              name: pusher-dropbox
              key: bucket
        - name: EXPERIMENT
          value: fast-sidestream
        - name: ARCHIVE_SIZE_THRESHOLD
          value: 50MB
        - name: MLAB_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        # TODO: specify the node & site names using kubernetes magic.
        volumeMounts:
        - name: fast-sidestream-data
          mountPath: /var/spool/fast-sidestream
        - name: pusher-credentials
          mountPath: /etc/credentials
          readOnly: true

      initContainers:
      # TODO: this is a hack. Remove the hack by fixing the contents of
      # resolv.conf
      - name: fix-resolv-conf
        image: busybox
        command: ['sh', '-c', 'echo "nameserver 8.8.8.8" > /etc/resolv.conf']

      # Write out the UUID prefix to a well-known location.
      # For more on this, see DESIGN.md in https://github.com/m-lab/uuid/
      - name: set-up-uuid-prefix-file
        image: measurementlab/uuid:v0.1
        args:
        - -filename=/var/local/uuid/prefix
        volumeMounts:
        - name: uuid-prefix
          mountPath: /var/local/uuid

      volumes:
      - name: fast-sidestream-data
        hostPath:
          path: /cache/core/fast-sidestream
          type: DirectoryOrCreate
      - name: pusher-credentials
        secret:
          secretName: pusher-credentials
      - name: ndt-tls
        secret:
          secretName: ndt-tls
      - name: uuid-prefix
        emptyDir: {}
