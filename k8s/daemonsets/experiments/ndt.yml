apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: ndt
  namespace: default
spec:
  selector:
    matchLabels:
      run: ndt
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      # TODO: Find a way of ensuring that "5%" never takes an entire site down
      # at once.
      maxUnavailable: 5%
  template:
    metadata:
      labels:
        run: ndt
      annotations:
        prometheus.io/scrape: 'true'
        k8s.v1.cni.cncf.io/networks: '[{ "name": "index2ip-index-2-conf" }]'
    spec:
      # The default grace period after k8s sends SIGTERM is 30s. We extend the
      # grace period to give time for the following shutdown sequence. After the
      # grace period, kubernetes sends SIGKILL.
      #
      # NDT pod shutdown sequence:
      #
      #  * k8s sends SIGTERM to NDT server
      #  * NDT server enables lame duck status
      #  * monitoring reads lame duck status (60s max)
      #  * mlab-ns updates server status (60s max)
      #  * all currently running tests complete. (30s max)
      #
      # Feel free to change this to a smaller value for speedy sandbox
      # deployments to enable faster compile-run-debug loops, but 60+60+30=150
      # is what it needs to be for staging and prod.
      terminationGracePeriodSeconds: 150

      nodeSelector:
        mlab/type: 'platform'
      containers:
      - name: ndt-server
        image: measurementlab/ndt-server:v0.6.3
        args:
        - -key=/certs/key.pem
        - -cert=/certs/cert.pem
        - -uuid-prefix-file=/var/local/uuid/prefix
        - -metrics_port=:9090
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: ndt-tls
          mountPath: /certs
          readOnly: true
        - name: uuid-prefix
          mountPath: /var/local/uuid
          readOnly: true

      - name: tcpinfo
        image: measurementlab/tcp-info:v0.0.6
        args:
        - -prom=:9091
        - -output=/var/spool/ndt/tcpinfo
        - -uuid-prefix-file=/var/local/uuid/prefix
        ports:
        - containerPort: 9091
        volumeMounts:
        - name: tcpinfo-data
          mountPath: /var/spool/ndt/tcpinfo
        - name: uuid-prefix
          mountPath: /var/local/uuid
          readOnly: true

      - name: traceroute
        image: measurementlab/traceroute-caller:v0.0.2
        args:
        #- -prom=:9092  # TODO: add monitoring for scamper
        - -outputPath=/var/spool/ndt/traceroute
        - -uuid-prefix-file=/var/local/uuid/prefix
        #ports:  # TODO: add monitoring for scamper
        #- containerPort: 9092
        volumeMounts:
        - name: traceroute-data
          mountPath: /var/spool/ndt/traceroute/
        - name: uuid-prefix
          mountPath: /var/local/uuid
          readOnly: true

      - name: pusher
        image: measurementlab/pusher:v1.7
        ports:
        - containerPort: 9093
        args:
        - -monitoring_address=:9093
        - -experiment=ndt
        - -archive_size_threshold=50MB
        - -directory=/var/spool/ndt
        - -datatype=tcpinfo
        - -datatype=traceroute
        env:
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /etc/credentials/pusher.json
        - name: BUCKET
          valueFrom:
            configMapKeyRef:
              name: pusher-dropbox
              key: bucket
        - name: MLAB_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - name: tcpinfo-data
          mountPath: /var/spool/ndt/tcpinfo
        - name: traceroute-data
          mountPath: /var/spool/ndt/traceroute/
        - name: pusher-credentials
          mountPath: /etc/credentials
          readOnly: true

      initContainers:
      # TODO: this is a hack. Remove the hack by fixing the contents of
      # resolv.conf
      - name: fix-resolv-conf
        image: busybox
        command: ['sh', '-c', 'echo "nameserver 8.8.8.8" > /etc/resolv.conf']

      # Write out the UUID prefix to a well-known location.
      # For more on this, see DESIGN.md in https://github.com/m-lab/uuid/
      - name: set-up-uuid-prefix-file
        image: measurementlab/uuid:v0.1
        args:
        - -filename=/var/local/uuid/prefix
        volumeMounts:
        - name: uuid-prefix
          mountPath: /var/local/uuid

      volumes:
      - name: tcpinfo-data
        hostPath:
          path: /cache/core/ndt/tcpinfo
          type: DirectoryOrCreate
      - name: traceroute-data
        hostPath:
          path: /cache/core/ndt/traceroute
          type: DirectoryOrCreate
      - name: pusher-credentials
        secret:
          secretName: pusher-credentials
      - name: ndt-tls
        secret:
          secretName: ndt-tls
      - name: uuid-prefix
        emptyDir: {}
