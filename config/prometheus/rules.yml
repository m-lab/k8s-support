groups:
- name: rules.yml
  rules:

## PlatformCluster

  #  Sums by container_name the 5m rate of CPU usage for a container.
  - record: container_name:container_cpu_usage_seconds:sum_rate5m
    expr: |
      sum by (container_label_io_kubernetes_container_name) (
        rate (container_cpu_usage_seconds_total{
          container_label_io_kubernetes_container_name != "POD",
          container_label_io_kubernetes_container_name != "",
          machine=~"mlab[1-4].*",
          image != ""}
        [5m])
      )

  # Sums by machine and container_name the 5m rate of CPU usage.
  - record: machine_container_name:container_cpu_usage_seconds:sum_rate5m
    expr: |
      sum by (machine, container_label_io_kubernetes_container_name) (
        rate (container_cpu_usage_seconds_total{
          container_label_io_kubernetes_container_name != "POD",
          container_label_io_kubernetes_container_name != "",
          image != ""}
        [5m])
      )

  # Calculates container memory usage as a ratio of all memory on a machine.
  - record: container:container_memory_working_set_bytes:ratio
    expr: |
      container_memory_working_set_bytes{
        container_label_io_kubernetes_container_name != "POD",
        container_label_io_kubernetes_container_name != "",
        machine=~"mlab[1-4].*",
        image != ""
      } / on(machine) group_left machine_memory_bytes

  # Calculates container memory usage (sum of all bytes).
  - record: container:container_memory_working_set_bytes:sum
    expr: |
      container_memory_working_set_bytes{
        container_label_io_kubernetes_container_name != "POD",
        container_label_io_kubernetes_container_name != "",
        machine=~"mlab[1-4].*",
        image != ""
      }

