groups:
- name: rules.yml
  rules:

## PlatformCluster

  ## CPU METRICS

  #  Calculates aggregate 5m rate of CPU usage for a container across all
  #  machines.
  - record: container_name:container_cpu_usage_seconds:sum_rate5m
    expr: |
      sum by (container_label_io_kubernetes_container_name) (
        rate (container_cpu_usage_seconds_total{
          container_label_io_kubernetes_container_name != "POD",
          container_label_io_kubernetes_container_name != "",
          machine=~"mlab[1-4].*",
          image != ""}
        [5m])
      )

  #  Calculates aggregate 5m rate of CPU usage for a container across all
  #  machines as a ratio of all CPU cores on all machines.
  - record: container_name:container_cpu_usage_seconds:ratio
    expr: |
      container_name:container_cpu_usage_seconds:sum_rate5m
      / scalar(sum(machine_cpu_cores))

  # Calculates aggregate container CPU usage on a machine.
  - record: machine_container_name:container_cpu_usage_seconds:sum_rate5m
    expr: |
      sum by (machine, container_label_io_kubernetes_container_name) (
        rate (container_cpu_usage_seconds_total{
          container_label_io_kubernetes_container_name != "POD",
          container_label_io_kubernetes_container_name != "",
          machine=~"mlab[1-4].*",
          image != ""}
        [5m])
      )

  # Calculates aggregate container CPU usage on a node as a ratio of all CPU
  # cores on that machine.
  - record: machine_container_name:container_cpu_usage_seconds:ratio
    expr: |
      sum by (machine, container_label_io_kubernetes_container_name) (
        rate (container_cpu_usage_seconds_total{
          container_label_io_kubernetes_container_name != "POD",
          container_label_io_kubernetes_container_name != "",
          machine=~"mlab[1-4].*",
          image != ""}
        [5m])
      ) / on(machine) group_left machine_cpu_cores


  ## MEMORY METRICS

  #  Calculates aggregate container memory usage across all machines.
  - record: container_name:container_memory_working_set_bytes:sum
    expr: |
      sum by (container_label_io_kubernetes_container_name) (
        container_memory_working_set_bytes{
          container_label_io_kubernetes_container_name != "POD",
          container_label_io_kubernetes_container_name != "",
          machine=~"mlab[1-4].*",
          image != ""
        }
      )

  #  Calculates aggregate container memory usage across all machines as a ratio of
  #  all memory on all machines.
  - record: container_name:container_memory_working_set_bytes:ratio
    expr: |
      container_name:container_memory_working_set_bytes:sum
      / scalar(sum(machine_memory_bytes))

  # Calculates aggregate container memory usage on a machine.
  - record: machine_container_name:container_memory_working_set_bytes:sum
    expr: |
      sum by (machine, container_label_io_kubernetes_container_name) (
        container_memory_working_set_bytes{
          container_label_io_kubernetes_container_name != "POD",
          container_label_io_kubernetes_container_name != "",
          machine=~"mlab[1-4].*",
          image != ""
        }
      )

  # Calculates aggregate container memory usage on a machine as a ratio of all
  # memory on that machine.
  - record: machine_container_name:container_memory_working_set_bytes:ratio
    expr: |
      sum by (machine, container_label_io_kubernetes_container_name) (
        container_memory_working_set_bytes{
          container_label_io_kubernetes_container_name != "POD",
          container_label_io_kubernetes_container_name != "",
          machine=~"mlab[1-4].*",
          image != ""
        } / on(machine) group_left machine_memory_bytes
      )

